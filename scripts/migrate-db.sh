#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å SQLite –Ω–∞ PostgreSQL

set -e

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$DB_USER" ] || [ -z "$DB_PASSWORD" ] || [ -z "$DB_NAME" ]; then
  echo "–û—à–∏–±–∫–∞: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è DB_USER, DB_PASSWORD –∏ DB_NAME"
  echo "–ü—Ä–∏–º–µ—Ä:"
  echo "export DB_USER=timetracker_user"
  echo "export DB_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å"
  echo "export DB_NAME=timetracker"
  exit 1
fi

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ PostgreSQL..."

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π DATABASE_URL, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f .env ]; then
  OLD_DB_URL=$(grep DATABASE_URL .env || echo "")
  echo "üìã –°–æ—Ö—Ä–∞–Ω–µ–Ω —Ç–µ–∫—É—â–∏–π URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: $OLD_DB_URL"
  # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é .env —Ñ–∞–π–ª–∞
  cp .env .env.backup
  echo "üìë –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è .env —Ñ–∞–π–ª–∞ (.env.backup)"
fi

# –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ PostgreSQL
echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL..."
echo "üíæ –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."

sudo -u postgres psql << EOF
CREATE DATABASE $DB_NAME;
CREATE USER $DB_USER WITH ENCRYPTED PASSWORD '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
EOF

# –û–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º URL
NEW_DB_URL="postgresql://$DB_USER:$DB_PASSWORD@localhost:5432/$DB_NAME"
echo "DATABASE_URL=\"$NEW_DB_URL\"" > .env.production

echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
echo "‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env.production —Å –Ω–æ–≤—ã–º URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç Prisma —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç Prisma..."
npx prisma generate

# –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏
echo ""
echo "‚ö†Ô∏è –í–ê–ñ–ù–û: –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:"
echo "1) –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞—Å—Ç —Ç–æ–ª—å–∫–æ —Å—Ö–µ–º—É)"
echo "2) –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ SQLite –≤ PostgreSQL (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)"
echo ""
read -p "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç (1/2): " migration_option

if [ "$migration_option" = "1" ]; then
  # –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
  echo "üîß –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
  DATABASE_URL="$NEW_DB_URL" npx prisma migrate deploy
  echo "‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
elif [ "$migration_option" = "2" ]; then
  # –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
  echo "‚ö†Ô∏è –î–ª—è –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞."
  echo "üìã –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –≤—Ä—É—á–Ω—É—é:"
  echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite"
  echo "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç pgloader –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:"
  echo "   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pgloader: sudo apt-get install pgloader"
  echo "   - –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é"
  echo ""
  echo "üìÑ –ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã –¥–ª—è pgloader:"
  echo "pgloader sqlite:./prisma/dev.db postgresql://$DB_USER:$DB_PASSWORD@localhost:5432/$DB_NAME"
else
  echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
  exit 1
fi

echo ""
echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env.production –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ .env"
echo "2. –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: npm run build"
echo "3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: pm2 restart time-tracker-app"
echo "" 